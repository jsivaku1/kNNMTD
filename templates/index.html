<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kNNMTD Synthetic Data Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="main-grid">
        <div class="info-container">
            <div class="info-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-icon"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                <h1 class="custom-gradient-title">kNNMTD Generator</h1>
            </div>
            <p class="tagline">Intelligent Synthetic Data for Complex Datasets</p>
            
            <div class="feature-box">
                <h3>Why kNNMTD Stands Out</h3>
                <p>kNNMTD is specifically designed to overcome the challenges of generating high-quality synthetic data from small and imbalanced datasets, a common problem in many real-world scenarios.</p>
                <ul>
                    <li><span class="highlight">Handles Minority Classes:</span> Its iterative, row-by-row approach ensures that even rare data patterns are learned and represented in the synthetic output.</li>
                    <li><span class="highlight">Preserves Data Structure:</span> By finding neighbors for each data point and diffusing per attribute, it maintains the complex relationships and correlations present in the original data.</li>
                    <li><span class="highlight">Automated & Smart:</span> This tool automates the entire pipeline, from data cleaning and preparation to finding the optimal 'k' value for the best results.</li>
                </ul>
            </div>
        </div>

        <div class="container action-container">
            <h2>Start Generating</h2>
            <p>Upload a dataset to begin the analysis and generation process.</p>
            
            <form action="/generate" method="post" enctype="multipart/form-data" id="generation-form">
                
                <div class="form-group">
                    <label for="dataset">1. Upload Your Dataset (.csv)</label>
                    <input type="file" id="dataset" name="dataset" accept=".csv" required>
                </div>

                <div id="big-data-section" class="hidden warning-box">
                    <p><strong>Big Data Mode Activated:</strong> Your dataset has <strong id="row-count-display"></strong> rows. To ensure fast performance, we will run the algorithm on a smaller, representative sample.</p>
                    <div class="form-group-inline">
                        <input type="checkbox" id="big_data_mode" name="big_data_mode" checked>
                        <label for="big_data_mode">Enable Sampling</label>
                    </div>
                    <div class="form-group">
                        <label for="sample_size">Sample Size</label>
                        <input type="number" id="sample_size" name="sample_size" min="1000" step="1000">
                    </div>
                </div>

                <div class="form-group" id="target-column-group">
                    <label for="class_col">2. Select Target Column (Optional)</label>
                    <select id="class_col" name="class_col">
                        <option value="none">None (Unsupervised Task)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="k_value">3. Select 'k' Value (will be optimized automatically)</label>
                    <select name="k_value" id="k_value" required>
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="7">7</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="n_epochs">4. Number of Epochs</label>
                    <input type="number" id="n_epochs" name="n_epochs" value="10" min="1" max="100" step="1" required>
                </div>

                <div class="form-group">
                    <label for="n_obs">5. Number of Synthetic Samples</label>
                    <input type="number" id="n_obs" name="n_obs" value="100" min="10" step="10" required>
                </div>
                
                <div class="form-group">
                    <label>6. Generation Mode</label>
                    <div class="radio-button-group">
                        <input type="radio" id="mode-standalone" name="generation_mode" value="standalone" checked>
                        <label for="mode-standalone">Generate New Dataset</label>
                        <input type="radio" id="mode-augment" name="generation_mode" value="augment">
                        <label for="mode-augment">Augment Real Data</label>
                    </div>
                </div>

                <!-- This progress container replaces the modal -->
                <div class="progress-container hidden" id="progress-container">
                    <div class="progress-bar-label">Generating Data...</div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progress-bar-fill"></div>
                    </div>
                </div>

                <button type="submit" class="btn" id="generate-btn">Generate Data</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('dataset');
            const targetSelect = document.getElementById('class_col');
            const form = document.getElementById('generation-form');
            const generateBtn = document.getElementById('generate-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const bigDataSection = document.getElementById('big-data-section');
            const rowCountDisplay = document.getElementById('row-count-display');
            const sampleSizeInput = document.getElementById('sample_size');

            fileInput.addEventListener('change', async function() {
                const file = this.files[0];
                if (!file) return;
                
                bigDataSection.classList.add('hidden');
                targetSelect.innerHTML = '<option value="none">None (Unsupervised Task)</option>';
                
                const formData = new FormData();
                formData.append('dataset', file);

                try {
                    const response = await fetch('/info', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Server error during analysis.');
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    if (data.is_big_data) {
                        rowCountDisplay.textContent = data.row_count.toLocaleString();
                        sampleSizeInput.value = data.default_sample_size;
                        bigDataSection.classList.remove('hidden');
                    }

                    if (data.categorical && data.categorical.length > 0) {
                        const optgroupCat = document.createElement('optgroup');
                        optgroupCat.label = 'Categorical (for Classification)';
                        data.categorical.forEach(col => {
                            optgroupCat.innerHTML += `<option value="${col.name}">${col.name}</option>`;
                        });
                        targetSelect.appendChild(optgroupCat);
                    }

                    if (data.numerical && data.numerical.length > 0) {
                        const optgroupNum = document.createElement('optgroup');
                        optgroupNum.label = 'Numerical (for Regression)';
                        data.numerical.forEach(col => {
                            optgroupNum.innerHTML += `<option value="${col.name}">${col.name}</option>`;
                        });
                        targetSelect.appendChild(optgroupNum);
                    }

                } catch (error) {
                    alert(`Error analyzing file: ${error.message}`);
                }
            });
            
            form.addEventListener('submit', () => {
                // This is the key fix: hide the button and show the inline progress bar
                generateBtn.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                progressBarFill.style.transition = 'none';
                progressBarFill.style.width = '0%';
                setTimeout(() => { 
                    progressBarFill.style.transition = 'width 10s ease-in-out';
                    progressBarFill.style.width = '100%'; 
                }, 100);
            });
        });
    </script>
</body>
</html>