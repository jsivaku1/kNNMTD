<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generation Complete</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container results-container">
        <div class="header-flex">
            <h1>Generation Complete! ✅</h1>
            <div class="runtime-box">
                <span>Total Runtime</span>
                <span class="metric-value final">{{ input_options['Total Runtime'] }}</span>
            </div>
        </div>
        <p>Your synthetic dataset and performance analysis are ready.</p>
        
        <div class="summary-grid">
            <div class="summary-card">
                <h2>Pipeline Summary</h2>
                <ul class="pipeline-list">
                    {% for title, description in pipeline_stages %}
                        <li>
                            <div class="pipeline-icon">✓</div>
                            <div class="pipeline-text">
                                <span class="pipeline-title">{{ title }}</span>
                                <span class="pipeline-description">{{ description }}</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="summary-card">
                <h2>Run Overview</h2>
                <table class="summary-table">
                    {% for key, value in input_options.items() %}
                        <tr>
                            <td>{{ key }}</td>
                            <td>{{ value }}</td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <h2 class="section-header">Metric Comparison</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Initial Metrics <span class="epoch-label">(After Epoch 1)</span></h3>
                <table class="summary-table">
                    {% for key, value in initial_metrics.items() %}
                    <tr>
                        <td>{{ key | title | replace('_', ' ') }}</td>
                        <td><span class="metric-value">{{ value }}</span></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="summary-card">
                <h3>Final Metrics <span class="epoch-label">(Optimized)</span></h3>
                <table class="summary-table">
                    {% for key, value in final_metrics.items() %}
                    <tr>
                        <td>{{ key | title | replace('_', ' ') }}</td>
                        <td><span class="metric-value final">{{ value }}</span></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <h2 class="section-header">Training & Closeness Plots</h2>
        <div class="actions-footer" style="margin-bottom: 2rem; border-top: none; padding-top: 0; flex-direction: column; align-items: flex-start;">
             <p class="chart-explanation" style="margin: 0.5rem 0 1rem 0;">The plots below show the evolution of data quality over the generation epochs. For a deeper, interactive analysis of the final data, launch the Analysis Wizard.</p>
             <a href="{{ url_for('analyze', real=original_real_filename, synth=generated_filename) }}" class="btn wizard-btn" style="width: auto;">
                Launch Analysis Wizard
            </a>
        </div>
        <div class="chart-grid">
            <div class="chart-card">
                <h2>PCD Score Over Epochs</h2>
                <canvas id="pcdChart"></canvas>
            </div>
            {% for metric_name, metric_values in ml_metrics_over_time.items() %}
                <div class="chart-card">
                    <h2>{{ metric_name | title | replace('_', ' ') }} Over Epochs</h2>
                    <canvas id="mlChart-{{ metric_name }}"></canvas>
                </div>
            {% endfor %}
        </div>
        
        <div class="actions-footer">
            <a href="{{ url_for('download_file', folder='generated', filename=generated_filename) }}" class="btn download-btn">
                Download Synthetic Data (.csv)
            </a>
            <a href="{{ url_for('index') }}" class="link-back">Generate another dataset</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pcdScores = {{ pcd_scores | tojson }};
            const mlMetricsOverTime = {{ ml_metrics_over_time | tojson }};
            const epochs = Array.from({ length: pcdScores.length }, (_, i) => `Epoch ${i + 1}`);

            if (pcdScores && pcdScores.length > 0) {
                const pcdCtx = document.getElementById('pcdChart').getContext('2d');
                new Chart(pcdCtx, {
                    type: 'line', data: { labels: epochs, datasets: [{ label: 'PCD Score', data: pcdScores, borderColor: '#38BDF8', backgroundColor: 'rgba(56, 189, 248, 0.2)', fill: true, tension: 0.3 }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'PCD Value' } }, x: { title: { display: true, text: 'Generation Epoch' } } } }
                });
            }

            if (mlMetricsOverTime && Object.keys(mlMetricsOverTime).length > 0) {
                const colors = ['#EC4899', '#10B981', '#F59E0B', '#8B5CF6', '#F97316'];
                let colorIndex = 0;
                for (const [metricName, metricValues] of Object.entries(mlMetricsOverTime)) {
                    if (metricValues && metricValues.length > 0) {
                        const chartId = `mlChart-${metricName}`;
                        const mlCtx = document.getElementById(chartId).getContext('2d');
                        new Chart(mlCtx, {
                            type: 'line',
                            data: { labels: epochs, datasets: [{ label: metricName, data: metricValues, borderColor: colors[colorIndex % colors.length], fill: false, tension: 0.3 }] },
                            options: { responsive: true, scales: { y: { beginAtZero: false, title: { display: true, text: 'Metric Score' } } }, plugins: { legend: { display: false } } }
                        });
                        colorIndex++;
                    }
                }
            }
        });
    </script>
</body>
</html>